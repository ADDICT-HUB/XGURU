// skill_pdf.js - Fixed & Integrated
// Author: NI MBAYA
// Username: GuruTech
// Botname: XGURU
// Repository: https://github.com/ADDICT-HUB/XGURU

const { evt } = require("../gift");
const fs = require("fs-extra");
const path = require("path");
const config = require("../config");

let PDFDocument;
try {
    PDFDocument = require("pdfkit");
    console.log("âœ… PDFKit module loaded - NI MBAYA ðŸ˜…");
} catch (error) {
    console.log("âš ï¸ PDFKit not available, using fallback mode");
    PDFDocument = null;
}

// --- UTILITY: PDF GENERATOR ---
function createSimplePDF(text, filename) {
    return new Promise((resolve, reject) => {
        try {
            if (!PDFDocument) {
                const fallbackContent = `ð—-ð†ð”ð‘ð” ððƒð… ðƒðŽð‚ð”ðŒð„ðð“\n\nGenerated by XGURU Bot\nAuthor: NI MBAYA\nContent:\n${text}`;
                fs.writeFileSync(filename, fallbackContent);
                return resolve(filename);
            }
            
            const doc = new PDFDocument();
            const stream = fs.createWriteStream(filename);
            doc.pipe(stream);
            
            // Branding Header
            doc.fontSize(22).text('ð—-ð†ð”ð‘ð” ðŒðƒ ððƒð…', { align: 'center' }).moveDown();
            doc.fontSize(10).text('Generated by: NI MBAYA', { align: 'center' });
            doc.text('Repo: https://github.com/ADDICT-HUB/XGURU', { align: 'center' }).moveDown(2);
            
            // Content
            doc.fontSize(12).text(text, { align: 'left' });
            doc.end();
            
            stream.on('finish', () => resolve(filename));
            stream.on('error', reject);
        } catch (error) { reject(error); }
    });
}

// --- COMMAND: TO PDF ---
evt({
    pattern: "topdf",
    desc: "Convert text to professional PDF",
    category: "tools"
}, async (from, Gifted, { args, q, reply }) => {
    try {
        if (!q) return reply(`*NI MBAYA!* âš ï¸ Please provide text.\nExample: ${config.PREFIX}topdf Hello GuruTech`);

        await reply("â³ *Processing PDF... Please wait.*");
        
        const filename = `xguru-${Date.now()}.pdf`;
        const filepath = path.join(__dirname, "..", "temp", filename);
        await fs.ensureDir(path.dirname(filepath));

        await createSimplePDF(q, filepath);

        await Gifted.sendMessage(from, {
            document: fs.readFileSync(filepath),
            mimetype: "application/pdf",
            fileName: `XGURU_DOC_${Date.now()}.pdf`,
            caption: `ðŸ“„ *ððƒð… ð†ð„ðð„ð‘ð€ð“ð„ðƒ ð’ð”ð‚ð‚ð„ð’ð’ð…ð”ð‹ð‹ð˜*\n\nâ‹„ *Author:* NI MBAYA\nâ‹„ *Source:* XGURU MD\n\n> *NI MBAYA ðŸ˜…*`
        });

        // Cleanup temp file
        setTimeout(() => fs.unlink(filepath).catch(() => {}), 10000);
        
    } catch (error) {
        console.error("PDF Error:", error);
        reply("âŒ *Error generating PDF.* Ensure `pdfkit` is installed.");
    }
});

// --- COMMAND: TEXT FILE ---
evt({
    pattern: "textfile",
    desc: "Convert text to .txt file",
    category: "tools"
}, async (from, Gifted, { q, reply }) => {
    try {
        if (!q) return reply("âš ï¸ Please provide text for the file.");

        const filename = `xguru-${Date.now()}.txt`;
        const filepath = path.join(__dirname, "..", "temp", filename);
        await fs.ensureDir(path.dirname(filepath));

        const content = `ð—-ð†ð”ð‘ð” ðŒðƒ ð“ð„ð—ð“ ð…ðˆð‹ð„\n\nAuthor: NI MBAYA\n\nContent:\n${q}`;
        fs.writeFileSync(filepath, content);

        await Gifted.sendMessage(from, {
            document: fs.readFileSync(filepath),
            mimetype: "text/plain",
            fileName: `XGURU_TEXT_${Date.now()}.txt`,
            caption: `ðŸ“ *ð“ð„ð—ð“ ð…ðˆð‹ð„ ð‚ð‘ð„ð€ð“ð„ðƒ*\n\nâ‹„ *Author:* NI MBAYA\n\n> *NI MBAYA ðŸ˜…*`
        });

        setTimeout(() => fs.unlink(filepath).catch(() => {}), 10000);
    } catch (e) { reply("âŒ Failed to create text file."); }
});

// --- COMMAND: DOC HELP ---
evt({
    pattern: "doc",
    desc: "Help for document tools",
    category: "tools"
}, async (from, Gifted, { reply }) => {
    const help = `
ðŸ“„ *ð—-ð†ð”ð‘ð” ðƒðŽð‚ð”ðŒð„ðð“ ð“ðŽðŽð‹ð’*

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
  â‹„ ${config.PREFIX}topdf (text)
  â‹„ ${config.PREFIX}textfile (text)
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

*System Status:*
â‹„ PDFKit: ${PDFDocument ? 'âœ… Ready' : 'âŒ Missing'}
â‹„ Author: NI MBAYA

> *NI MBAYA ðŸ˜…*`;
    return reply(help);
});

module.exports = { createSimplePDF };
console.log("âœ… PDF Tools plugin fully integrated - NI MBAYA ðŸ˜…");
